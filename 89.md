NIP-89
======

Application Handlers
--------------------

`draft` `optional`

This NIP describes a way to discover different types of applications that can handle unknown event-kinds.

## Rationale

Nostr's discoverability and transparent event interaction is one of its most interesting/novel mechanics.
This NIP provides a simple way for clients to discover applications that handle events of a specific kind to ensure smooth cross-client and cross-kind interactions.

## Overview

This NIP defines "application handlers", which are events intended to advertise support for a certain event kind. These handlers may be for several different types of nostr-related applications, including:

- `11991` for nostr clients
- `11992` for nostr DVMs
- `11993` for nostr relays

Applications SHOULD have their own nostr identity, and SHOULD publish a kind 0 profile, a kind 10002 relay list, and any other metadata events that may be helpful for consumers of the applications.

This NIP also defines a `kind:31989` application selection event which allows users to configure their default application handlers.

## Client Handler

A "client handler" is a `kind:11991` event which includes details about which event kinds are supported by a client, and how to send users to the application.

* `content` should be a human-readable description of the application
* One or more `k` tags indicate the event kind(s) that are supported by this client.
* One or more handler tags (`web|ios|android|<other>`) SHOULD be included, indicating url templates that other applications can use to redirect users to the client in question. The string `<bech32>` in a URL MUST be replaced by clients with the NIP-19-encoded entity that should be loaded by the application. An optional second argument indicates the type of NIP 19 entity expected.
* Additional tags MAY be included for classifying the handler, pointing to secondary web resources, etc.

```jsonc
{
  "kind": 11991,
  "pubkey": "<application-pubkey>",
  "content": "Xorx is a nostr app focused on short form and image posts.",
  "tags": [
    ["k", "1"],
    ["k", "20"],
    ["web", "https://..../a/<bech32>", "nevent"],
    ["web", "https://..../p/<bech32>", "nprofile"],
    ["web", "https://..../e/<bech32>"],
    ["ios", ".../<bech32>"],
    ["t", "breakfast"],
    ["r", "https://github.com/hzrd149/cherry-tree", "source"],
    ["zap", "266815e0c9210dfa324c6cba3573b14bee49da4209a9456f9484e5106cd408a5", "wss://relay.nostr.band", "9"]
  ],
  // other fields...
}
```

## DVM Handler

A "DVM handler" is a `kind:11991` event which includes details about which event kinds are supported by a DVM, and how to send requests to the service.

* `content` should be a human-readable description of the application
* One or more `k` tags indicate the event kind(s) that are supported by this DVM.

Example:

```jsonc
{
  "kind": 11991,
  "pubkey": "<application-pubkey>",
  "content": "Xorx is a nostr DVM that provides content recommendations.",
  "tags": [
    ["k", "5300"]
  ],
  // other fields...
}
```

## Relay Handler

A "Relay handler" is a `kind:11992` event which includes details about how to reach the relay.

* `content` should be a human-readable description of the application
* One or more `r` tags MUST be included indicating urls that the relay is accessible on.

Example:

```jsonc
{
  "kind": 11991,
  "pubkey": "<application-pubkey>",
  "content": "Xorx is a nostr relay.",
  "tags": [
    ["r", "wss://nostr.sovbit.host/"],
    ["r", "ws://127.0.0.1:8000/"],
    ["r", "ws://sovbitgz5uqyh7jwcsudq4sspxlj4kbnurvd3xarkkx2use3k6rlibqd.onion/"],
    ["r", "gnunet://fs/ksk/gpl"]
  ],
  // other fields...
}
```

## Handler selections

A "handler selection" is an event that indicates that a given application is a good fit for handling some nostr kind in a certain context.

- Its `d` tag MUST BE the supported event kind this event is selecting applications for.
- One or more `a` tags indicate selected apps by nostr address. A relay hint MUST be included. If the selected application is a client, the third tag argument SHOULD be a platform string.

In order to select handlers for multiple kinds, users must publish multiple `kind:31989` events.

```jsonc
{
  "kind": 31989,
  "pubkey": <user-pubkey>,
  "tags": [
    ["d", <supported-event-kind>],
    ["a", "11991:<app1-pubkey>", "wss://relay1", "ios"],
    ["a", "11991:<app2-pubkey>", "wss://relay2", "web"],
    ["a", "11992:<app2-pubkey>", "wss://relay3"]
  ],
  // other fields...
}
```

## Recommendation Flow

Kind `31989` selection events MAY be used to recommend applications to other users, but they SHOULD NOT be treated as unqualified endorsements.

There are three actors in this workflow:

* A client that handles a specific event kind
  * Publishes `kind:11991`, detailing how apps should redirect to it
* User A, who selects an app that handles a specific event kind
  * Publishes `kind:31989`
* User B, who is looking an app that handles a specific event kind
  * Queries for `kind:31989` and, based on results, queries for `kind:11991`

Let's say Alice has found a `kind:20` event in the wild, quoted in a kind 1 and her client doesn't render it except by showing its `alt` tag. In order to find people in her social graph who use clients that support `kind:20`, her client might send out a request with a filter something like this:

```jsonc
{
  "authors": [<alice's follow list>],
  "kinds": [31989],
  "#d": ["20"]
}
```

This will retrieve usage data for clients that support kind 20. One of them might look like this:

```
{
  "kind": 31989,
  "tags": [
    ["d", "20"],
    ["a", "11991:1743058db7078661b94aaf4286429d97ee5257d14a86d6bfa54cb0482b876fb0", "wss://relay.example.com/", "web"]
  ],
  // other fields...
}
```

Alice's client can them retrieve the referenced handler from `wss://relay.example.com/` (or the address pubkey's 10002 write relays) using the following filter:

```
{
  "authors": ["1743058db7078661b94aaf4286429d97ee5257d14a86d6bfa54cb0482b876fb0"],
  "kinds": [11991]
}
```

This would turn up an application handler that might look something like this:

```
{
  "kind": 11991,
  "pubkey": "<application-pubkey>",
  "content": "Xorx is an application that supports kind 20 image posts.",
  "tags": [
    ["k", "20"],
    ["web", "https://my-nostr-client.com/e/<bech32>"],
    ["ios", ".../<bech32>"]
  ],
  // other fields...
}
```

Alice's client can now show some indication that another client might be better suited to hande this event. She can then click a button (or something), and the client can fill out a template and redirect Alice. For example the `web` template might look like this:

```
https://my-nostr-client.com/e/nevent1qvzqqqqqzspzpq35r7yzkm4te5460u00jz4djcw0qa90zku7739qn7wj4ralhe4zqyvhwumn8ghj7urjv4kkjatd9ec8y6tdv9kzumn9wshsz9nhwden5te0wfjkccte9ekk7um5wgh8qatz9uq3wamnwvaz7tmjv4kxz7fwwpexjmtpdshxuet59uqzqu58spynxnvuxf75r6ayua69cpv02k8ehur3zplmt7t7w8ayaguaaxlhuq
```

Alternatively, users might choose to query directly for `kind:11991` for an event kind. Clients SHOULD be careful doing this and use spam-prevention mechanisms or querying high-quality restricted relays to avoid directing users to malicious handlers.

# Appendix: Client Tag

When publishing events, clients MAY include a `client` tag. Identifying the client or DVM that published the note on behalf of the user. This tag is a tuple of `name`, `address` identifying a handler event, and a relay `hint` for finding the handler event. This has privacy implications for users, so clients SHOULD allow users to opt-out of using this tag.

```jsonc
{
  "kind": 1,
  "tags": [
    ["client", "My Client", "11991:<app1-pubkey>", "wss://relay1"]
  ]
  // other fields...
}
```

# Appendix: Legacy Handlers

In the past, handlers were designed to be self-contained metadata events published by application developers, rather than a dedicated application pubkey. This section describes the legacy `kind:31990` "legacy handler" event.

* `content` is an optional `metadata`-like stringified JSON object, as described in NIP-01. This content is useful when the pubkey creating the `kind:31990` is not an application. If `content` is empty, the `kind:0` of the pubkey should be used to display application information (e.g. name, picture, web, LUD16, etc.)
* One or more `k` tags indicate the event kind(s) that are supported by this client.
* One or more handler tags (`web|ios|android|<other>`) MUST be included, indicating url templates that other applications can use to redirect users to the client in question. The string `<bech32>` in a URL MUST be replaced by clients with the NIP-19-encoded entity that should be loaded by the application. An optional second argument indicates the type of NIP 19 entity expected.

```jsonc
{
  "kind": 31990,
  "pubkey": "<application-pubkey>",
  "content": "<kind0-style-metadata>",
  "tags": [
    ["d", 'EvAX3S1smP8'],
    ["k", "1"],
    ["k", "20"],
    ["web", "https://..../a/<bech32>", "nevent"],
    ["web", "https://..../p/<bech32>", "nprofile"],
    ["web", "https://..../e/<bech32>"],
    ["ios", ".../<bech32>"]
  ],
  // other fields...
}
```
